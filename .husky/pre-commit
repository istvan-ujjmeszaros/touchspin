#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Exit on any error
set -e

echo "ğŸ¶ Husky pre-commit: Gherkin workflow validation"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if any source files changed (rebuild devdist if so)
SRC_CHANGED=$(echo "$STAGED_FILES" | grep -E "packages/.*/src/.*\.(ts|tsx|js|jsx)$" || true)
if [ -n "$SRC_CHANGED" ]; then
  echo "ğŸ“¦ Source files changed, rebuilding devdist..."
  yarn build:test || { echo "âŒ DevDist build failed"; exit 1; }

  # Stage ALL updated devdist files
  git add packages/*/devdist packages/renderers/*/devdist
  echo "âœ… DevDist files rebuilt and staged"
fi

# Check if any helper files changed (regenerate lexicon if so)
HELPER_CHANGED=$(echo "$STAGED_FILES" | grep -E "packages/.*/tests/__shared__/helpers/.*\.(ts|js)$" || true)
if [ -n "$HELPER_CHANGED" ]; then
  echo "ğŸ“– Helper docs changed, regenerating Step Lexicon..."
  yarn lexicon:gen

  # Stage the updated lexicon if it exists and changed
  if [ -f "tests/STEP-LEXICON.md" ]; then
    git add tests/STEP-LEXICON.md
    echo "âœ… Step Lexicon updated and staged"
  fi
fi

# Check if any spec files or guard script changed (run guard if so)
SPEC_OR_GUARD_CHANGED=$(echo "$STAGED_FILES" | grep -E "\.(spec|guard)\.(ts|tsx|js|mjs)$" || true)
if [ -n "$SPEC_OR_GUARD_CHANGED" ]; then
  echo "ğŸ›¡ï¸ Spec or guard files changed, running Gherkin guard..."
  yarn test:guard || { echo "âŒ Gherkin guard failed"; exit 1; }
  echo "âœ… Gherkin guard passed"
fi

# Run guards for test quality
yarn guard:no-src-in-tests || { echo "âŒ src-in-tests guard failed"; exit 1; }
yarn guard:no-queryselector || { echo "âŒ querySelector guard failed"; exit 1; }
yarn guard:no-page-locator || { echo "âŒ page.locator guard failed"; exit 1; }

echo "âœ… Pre-commit validation complete"
