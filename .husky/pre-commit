#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Exit on any error
set -e

echo "üê∂ Husky pre-commit: Gherkin workflow validation"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if any helper files changed (regenerate lexicon if so)
HELPER_CHANGED=$(echo "$STAGED_FILES" | grep -E "packages/.*/tests/__shared__/helpers/.*\.(ts|js)$" || true)
if [ -n "$HELPER_CHANGED" ]; then
  echo "üìñ Helper docs changed, regenerating Step Lexicon..."
  yarn lexicon:gen

  # Stage the updated lexicon if it exists and changed
  if [ -f "tests/STEP-LEXICON.md" ]; then
    git add tests/STEP-LEXICON.md
    echo "‚úÖ Step Lexicon updated and staged"
  fi
fi

# Check if any spec files or guard script changed (run guard if so)
SPEC_OR_GUARD_CHANGED=$(echo "$STAGED_FILES" | grep -E "\.(spec|guard)\..*\.(ts|js|mjs)$" || true)
if [ -n "$SPEC_OR_GUARD_CHANGED" ]; then
  echo "üõ°Ô∏è Spec or guard files changed, running Gherkin guard..."
  yarn test:guard
  echo "‚úÖ Gherkin guard passed"
fi

# Run existing guard for src-in-tests
yarn guard:no-src-in-tests

echo "‚úÖ Pre-commit validation complete"
