<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TouchSpin Core Smoke Test (ESM, no jQuery)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../../src/jquery.bootstrap-touchspin.css" rel="stylesheet">
  <style>
    .test-section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
    .control-buttons button { margin: 4px; }
    pre { background:#f8f9fa; padding:10px; }
  </style>
  <script>
    // Disable CSP for local file serving contexts
  </script>
</head>
<body>
  <div class="container mt-4">
    <h1>TouchSpin Core Smoke Test</h1>
    <p>Standalone core instance via ESM; no jQuery dependency.</p>

    <div class="test-section">
      <div class="form-group">
        <label for="core-input">Numeric input:</label>
        <input id="core-input" type="text" value="10" class="form-control" />
      </div>
      <div class="control-buttons">
        <button id="btn-init" class="btn btn-primary">Init Core</button>
        <button id="btn-destroy" class="btn btn-danger">Destroy</button>
        <button id="btn-reinit" class="btn btn-success">Reinit</button>
      </div>
      <div class="control-buttons">
        <button id="btn-uponce" class="btn btn-outline-primary">upOnce()</button>
        <button id="btn-downonce" class="btn btn-outline-primary">downOnce()</button>
        <button id="btn-startup" class="btn btn-outline-primary">startUpSpin()</button>
        <button id="btn-startdown" class="btn btn-outline-primary">startDownSpin()</button>
        <button id="btn-stop" class="btn btn-outline-primary">stopSpin()</button>
        <button id="btn-get" class="btn btn-outline-secondary">getValue()</button>
        <button id="btn-set" class="btn btn-outline-secondary">setValue(64)</button>
        <button id="btn-update" class="btn btn-outline-secondary">updateSettings({ step: 10 })</button>
      </div>
      <div class="mt-2"><strong>Status:</strong> <span id="status">Not initialized</span></div>
      <h5 class="mt-3">Events</h5>
      <pre id="log"></pre>
    </div>

    <div class="test-section">
      <h3>Optional jQuery Bridge (manual)</h3>
      <p>This demonstrates how a wrapper can bridge core events to jQuery triggers.</p>
      <div><strong>Bridge status:</strong> <span id="jq-status">Not installed</span></div>
    </div>
  </div>

  <script type="module">
    import { createPublicApi, CORE_EVENTS } from '../../packages/core/src/index.js';

    const input = document.getElementById('core-input');
    const status = document.getElementById('status');
    const log = document.getElementById('log');
    const jqStatus = document.getElementById('jq-status');
    /** @type {ReturnType<typeof createPublicApi>|null} */
    let api = null;
    const unsubs = [];

    function addLog(msg) {
      const ts = new Date().toISOString().split('T')[1].replace('Z','');
      log.textContent += `[${ts}] ${msg}\n`;
      log.scrollTop = log.scrollHeight;
    }

    function subEvents(inst) {
      const events = [
        CORE_EVENTS.MIN,
        CORE_EVENTS.MAX,
        CORE_EVENTS.START_SPIN,
        CORE_EVENTS.START_UP,
        CORE_EVENTS.START_DOWN,
        CORE_EVENTS.STOP_SPIN,
        CORE_EVENTS.STOP_UP,
        CORE_EVENTS.STOP_DOWN,
      ];
      for (const ev of events) {
        unsubs.push(inst.on(ev, () => addLog(`core:${ev}`)));
      }
    }

    function init() {
      if (api) return;
      api = createPublicApi(input, { min: 0, max: 100, step: 1 });
      subEvents(api);
      status.textContent = 'Initialized (min 0, max 100, step 1)';

      // Optional: install a jQuery bridge if jQuery present (for parity checks)
      // eslint-disable-next-line no-undef
      if (window.jQuery) {
        const $ = window.jQuery;
        const $el = $(input);
        $el.data('touchspinInternal', api);
        const map = {
          [CORE_EVENTS.MIN]: 'touchspin.on.min',
          [CORE_EVENTS.MAX]: 'touchspin.on.max',
          [CORE_EVENTS.START_SPIN]: 'touchspin.on.startspin',
          [CORE_EVENTS.START_UP]: 'touchspin.on.startupspin',
          [CORE_EVENTS.START_DOWN]: 'touchspin.on.startdownspin',
          [CORE_EVENTS.STOP_SPIN]: 'touchspin.on.stopspin',
          [CORE_EVENTS.STOP_UP]: 'touchspin.on.stopupspin',
          [CORE_EVENTS.STOP_DOWN]: 'touchspin.on.stopdownspin',
        };
        for (const [k, v] of Object.entries(map)) {
          unsubs.push(api.on(k, () => $el.trigger(v)));
        }
        jqStatus.textContent = 'Bridge installed';
      }
    }

    function destroy() {
      if (!api) return;
      for (const u of unsubs.splice(0)) try { u(); } catch {}
      api.destroy();
      api = null;
      status.textContent = 'Destroyed';
    }

    document.getElementById('btn-init').addEventListener('click', init);
    document.getElementById('btn-destroy').addEventListener('click', destroy);
    document.getElementById('btn-reinit').addEventListener('click', () => { destroy(); init(); });

    document.getElementById('btn-uponce').addEventListener('click', () => api && api.upOnce());
    document.getElementById('btn-downonce').addEventListener('click', () => api && api.downOnce());
    document.getElementById('btn-startup').addEventListener('click', () => api && api.startUpSpin());
    document.getElementById('btn-startdown').addEventListener('click', () => api && api.startDownSpin());
    document.getElementById('btn-stop').addEventListener('click', () => api && api.stopSpin());
    document.getElementById('btn-get').addEventListener('click', () => api && addLog('getValue()=' + api.getValue()));
    document.getElementById('btn-set').addEventListener('click', () => api && api.setValue(64));
    document.getElementById('btn-update').addEventListener('click', () => api && api.updateSettings({ step: 10 }));
  </script>

  <!-- Optional jQuery for bridge demo only -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>
</html>

